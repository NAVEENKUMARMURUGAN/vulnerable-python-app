name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # SAST Scanning
      - name: Bandit Scan
        continue-on-error: true # This prevents the workflow from failing
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-results.json

      # Optionally, display results
      - name: Display Bandit Results
        run: |
          cat bandit-results.json

      # Code Quality with Pylint
      - name: Pylint Check
        continue-on-error: true # Don't fail the workflow
        run: |
          pip install pylint
          pylint --output-format=text --recursive=y . || true

      - name: Semgrep
        continue-on-error: true
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/python
            p/security-audit

      # Secret Scanning
      - name: GitLeaks Secret Scan
        continue-on-error: true
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Software Composition Analysis (SCA)
      - name: Safety Check
        continue-on-error: true
        run: |
          pip install safety
          safety check

      - name: Snyk Python Scan
        continue-on-error: true
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # DAST Scanning
      - name: Start Application
        continue-on-error: true
        run: |
          python app.py &
          sleep 5

      - name: OWASP ZAP Scan
        continue-on-error: true
        uses: zaproxy/action-full-scan@v0.4.0
        with:
          target: "http://localhost:5000"
